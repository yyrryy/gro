
<style>
  .select2-results__option{
    height: 10em;
  }
    .autocomplete {
  position: relative;
  width: 300px; /* Adjust as needed */
}

#search-input {
  width: 100%;
  padding: 10px;
}

#suggestion-list {
  position: absolute;
  list-style: none;
  background-color: white;
  border: 1px solid #ccc;
  max-height: 200px;
  overflow-y: auto;
  width: 100%;
  padding: 0;
  margin: 0;
}
</style>
<div class="text-white rounded h3 d-flex align-items-center justify-content-between bg-darkblue">
  <!-- <button class="btn bg-orange" style="border:1px solid var(--orange);" onclick="deletetab('')">x</button> -->
  <div>
    {{title}} {{target}}
  </div>
  <!-- <button class="btn bg-orange" style="border:1px solid var(--orange);" onclick="forceupdatetab()">↻</button> -->
</div>

  <div class="bonlivraisonparentdiv">
         <div class="bg-white rounded shadow p-2 mb-3 data d-flex justify-content-between">
            <div class="col-5">
                <div class="mb-2 clientselectblholder">
                    <div class="alert alert-danger p-2">
                      Sold: <strong class="sold"></strong>
                    </div>
                    <small>Clients:
                    </small>
                    <!-- <button type="button" name="button" class="btn bg-darkblue text-white" onclick="refreshselectclient(event)">↻</button> -->

                    <select name="client" id="" style="width:100%;" class="select2 clientselectbl form-select notemptylivraison select2client">
                        <!-- <option value="">---</option>
                        {% for i in clients %}
                        <option value="{{i.id}}">{{i.name}} | {{i.code}} | {{i.city}} | {{i.region}} | {{i.represent}} </option>
                        {% endfor %} -->
                    </select>
                </div>
                <!-- <div class="mb-2 cerpselectholder">
                    <small>Representant:</small> <strong class="text-danger repblname"></strong>
                    <select name="representant" id="" style="width:100%;" class="select2 repsselectsbl form-select notemptylivraison">
                        <option value="">---</option>
                        {% for i in commercials %}
                        <option value="{{i.id}}">{{i.name}}</option>
                        {% endfor %}
                    </select>
                </div> -->
                <div class="mb-2">
                    <input type="date" class="form-control datebonbl" name="datebon" placeholder="Date bon">
                </div>
                <div class="mb-2">
                  <input placeholder="transport" type="text" class="form-control transport" name="transport">
                </div>
                <div class="mb-2">
                    <input type="text" class="form-control note" name="note" placeholder="Note">
                </div>
            </div>

            <div class="col-7 row productsholder d-none">
              <div class="col-12">

                <select class="resultsholderbonlivraison mb-2 form-select " style="width: 100%;" id="productsselect2">

                </select>
              </div>
              <div class="col-3">
                <input type="number" class="form-control" placeholder="Quantité" name="addqty">
                <div class="addstock text-danger"></div>
                <div class="addstockfacture text-danger mt-2"></div>
              </div>
              <div class="col-3">
                <input type="number" class="form-control" placeholder="Prix" name="addprice">
                <div class="addclientprice text-danger"></div>
              </div>
              <div class="col-3">
                <input type="number" class="form-control" placeholder="Remise" name="addremise">
              </div>
              
              <div class="col-3">
                <button class="btn" onclick="addrowbonlivraison(event)" style="border: 4px solid;
                border-color: var(--darkblue);
                border-radius: 10px;
                height: 36px;
                text-align: center;
                background: #00800024;">Valider</button>
              </div>
              <input hidden readonly type="text" name="addname" class="form-control">
              {% include 'accordionqtyprice.html' %}
            </div>




          </div>

      <div>
          <div class="bg-white rounded shadow p-2 tableholder">
              <!-- <div>
                  <small>
                      Ref.
                  </small>
                  <input type="text" name="ref" class="form-control searchref">
              </div> -->
              <div class="d-flex justify-content-between">

                  <div class="mb-3 col-5">

                </div>

            </div>
            <div class="col-5">
              <input type="text" class="searchbonlivraisoncreation" placeholder="Search..." />
            </div>
            <table class="table table-bordered text-center bonlivraisoncreation">
              <thead style="background: orange; color:#091b27;">
                  <tr>
                      <td style="padding: 2px 0; font-size: 13px; width: 9%;">REF</td>
                      <td style="padding: 2px 0; font-size: 13px;">Article</td>
                      <td style="padding: 2px 0; font-size: 13px; width: 9%;">Dernier Pr.</td>
                      <td style="padding: 2px 0; font-size: 13px;">Stock</td>
                      <td style="padding: 2px 0; font-size: 13px; width: 9%;">Dernier Pr. cli</td>
                      <td style="padding: 2px 0; font-size: 13px;width: 6%;" >Quantité</td>
                      <td style="padding: 2px 0; font-size: 13px;width: 6%;" >Prix unit.</td>
                      <td style="padding: 2px 0; font-size: 13px;width: 3%;" >Remise</td>
                      <td style="padding: 2px 0; font-size: 13px;width: 6%;" >Prix Net</td>
                      <td style="padding: 2px 0; font-size: 13px;">Total</td>
                  </tr>
              </thead>
              <!-- <tfoot>
                <tr>
                  <td></td>
                  <td></td>
                  <td></td>
                  <td></td>
                  <td></td>
                  <td></td>
                  <td></td>
                  <td>TOTAL</td>
                  <td class="totalbon" style="background: orange; color:#091b27;">
                      0.00
                  </td>
                </tr>
              </tfoot> -->
              <tbody class="bonlivraisonbody">

              </tbody>
            </table>
            <div class="d-flex justify-content-between bg-white" style="position: sticky; bottom: 0;">
                <button class="btn btn-success submitbonlivraison" style="border-radius: 10px;">
                      Valider
                </button>
                <button class="btn btn-danger" onclick="annulerbon('bonlivraison{{target}}', '/products/listbonlivraison?target={{target}}')" style="border-radius: 10px;">
                  Annuler
                  </button>
                <b class="totalbon text-danger totalbonlivraison">
                  0.00
                </b>
            </div>
          </div>
          <div class="reglementbonsholder mt-3 border position-relative">

            <div class="inputsholder">
                <!-- <button style="background: #f06623;" class="btn btn-sm text-white" onclick="addfieldsreglement(event)">+</button> -->
                <!-- <strong class="totalreglblfields">0.00</strong> -->
                    <!-- <div class="row align-items-center">
                          <div class="col-3">
                              <small>Mantant:</small> <br>

                          </div>
                          <div class="col-3">
                              <small>N° piece:</small> <br>

                          </div>
                          <div class="col-3">
                              <small>Mode Paiment:</small> <br>

                          </div>
                          <div class="col-3">
                              <small>Echeance:</small> <br>

                          </div>
                      </div> -->
                    <!-- <div class="reglements">
                        <div class="row align-items-center mt-2">
                            <div class="col-3">
                                <input type="number" name="mantantreglementclient" oninput="totalreglementbl(event)" class="w-100 notempty" placeholder="Mantant">
                            </div>
                            <div class="col-3">
                                <input type="text" name="npiece" class="w-100 notempty" placeholder="N° piece">
                            </div>
                            <div class="col-3">
                                <select name="modereglementclient" class="w-100 notempty" onchange="checkmodereglement(event)">
                                    <option value="cheque">Cheque</option>
                                    <option value="effet">effet</option>
                                    <option value="espece">espece</option>
                                    <option value="verement">verement</option>
                                    <option value="versement">versement</option>
                                </select>
                            </div>
                            <div class="col-3">
                                <input type="date" name="echeance" class="w-100 notempty echeancereglbl" value="{{today|date:'Y-m-d'}}">
                            </div>
                        </div>
                    </div> -->
                </div>
            </div>
      </div>

  </div>

  <script>
    readingqrcode=true
    $(function(){

      $('.clientselectbl').select2({

        ajax: {
          type:'get',
          dataType: 'json',
          url: '/products/searchclient?target={{target}}',
          data: function (params) {
            var query = {
              term: params.term,
            }
            // Query parameters will be ?search=[term]&type=public
            return query;
          },
          proccessresults: function (data) {
              return {
                results:data.results
              }
          },
          cache:true
        },
        minimumInputLength: 1,
        placeholder:'Chercher client',
        templateResult: formatclient,
        templateSelection: formatclientSelection,
      });
      function formatclient (client) {
          if (client.loading) {
            return client.text;
          }

          var $container = $(
            `<strong style="color:${client.diver>0?"red":""};">${client.text}</div>`
            );



            return $container;
        }

        function formatclientSelection (client) {
          return client.text;
        }

    })
    charToNumberMap = {
            '&': '1',
            'é': '2',
            '"': '3',
            "'": '4',
            '(': '5',
            '-': '6',
            'è': '7',
            '_': '8',
            'ç': '9',
            'à': '0',
            'a': 'q',
            'z': 'w',
            'w': 'z',
            'q': 'a',
            ',': 'm',
            ')': '-'

        };

    // let barcode = '';
    // let typingTimer;

    // Convert character to corresponding number if mapped
    function convertCharToNumber(char) {
        return charToNumberMap[char] || char;
    }

    // Listen for keydown events on the document level
    $(document).on('keydown', (function() {
      let barcode = '';
      let typingTimer;

      return function(event) {
          if (typingTimer) clearTimeout(typingTimer);

          if (event.which === 13) {  // Enter key detected
            clientid = $('.clientselectbl').val()
            console.log('>> enter key')
            // if (clientid==null && readingqrcode){
            //   alertify.error('Veuillez choisir un client')
            //   return
            // }
              if (barcode) {
                // get the product with the ref in the qrcode
                $.get('products/barcodepdct', {'ref':barcode, 'target':'{{target}}'}, (data)=>{

                  var [ref, name, dp, stock, stockfacture, id, sellprice, remise, netprice, representprice] = data.data.split('§')
                  // add val to select2
                  $('.resultsholderbonlivraison').append(new Option(`${ref} - ${name}`, id, true, true))
                  let repswithprice=[]
                  let addname=$('input[name="addname"]')
                  let addprice=$('input[name="addprice"]')
                  let addremise=$('input[name="addremise"]')
                  let addqty=$('input[name="addqty"]')
                  console.log('qty of change',addqty)
                  $.get('/products/getqtyprice',
                  {
                    'target':'{{target}}',
                    'id':id
                  },
                  function(data){
                    $('.producthistory').html(data)
                  })
                  $('.addstock').text(stock)
                  $('.addstockfacture').text(stockfacture)
                  addqty.val('')
                  addprice.val(sellprice)
                  addremise.val(remise)
                  addname.val(`${ref} - ${name}`).attr('data', `${ref}§${name}§${dp}§${stock}§${stockfacture}§${id}§${sellprice}§${remise}§${netprice}§${representprice}`)
                  addprice.val(sellprice)
                  console.log('getting client price')
                  $.ajax({
                    url: "{% url 'products:getclientprice' %}",
                    type: 'POST',
                    data: {
                        'target':'{{target}}',
                        'id': id,
                        'clientid': $('.clientselectbl').val(),
                        'csrfmiddlewaretoken': '{{csrf_token}}'
                    },
                    success: function(data){
                      
                      $('.addclientprice').text(`${(data.price).toFixed(2)} (${data.remise})`)
                    }
                  })
                })

                    
                  console.log('Barcode:', barcode);
                  barcode = ''; // Reset the barcode after processing
              }
          } 
          else {
            // Accumulate characters, converting to numbers if mapped
            const key = event.key.toLowerCase();
            barcode += convertCharToNumber(key);

            // Reset barcode if no keys are pressed within a certain time
            typingTimer = setTimeout(() => {
              barcode = '';
            }, 100);  // Adjust timeout as needed to filter unintended keystrokes
          }
      }
      })());

    function getqtyprice(){
      console.log('getqtyprice')
      $.get('/products/getqtyprice',
      {
        'target':'{{target}}',
        'id':$('.resultsholderbonlivraison').val()
      },
      function(data){
        $('.producthistory').html(data)
      })
    }
    
    function removelinebl(event, id) {
          let parentdiv=$(event.target).parent().parent().parent().parent().parent().parent()
          clicksinbl++;

          if (clicksinbl === requiredClicks) {
              // User has clicked the element four times consecutively
              // Add your code to run when there are four consecutive clicks here
              alertify.confirm('Supprimer', 'Supprimer la ligne', function(){
                console.log('delete'),
                // remove element
                $(event.target).parent().remove()
                // remove id from localstorage

                pdcts=JSON.parse(localStorage.getItem('pdctsinbonlivraison{{target}}'))
                pdcts.splice(pdcts.indexOf(id.toString()), 1)
                localStorage.setItem('pdctsinbonlivraison{{target}}', JSON.stringify(pdcts))
                // update total
                let totalbon = parseFloat(parentdiv.find('.totalbonlivraison').text())
                let totalrow = parseFloat($(event.target).parent().find('.total').text())
                let totalbonvalue = (totalbon-totalrow).toFixed(2)
                parentdiv.find('.totalbonlivraison').html(totalbonvalue)
                // Reset the count
                clicksinbl = 0;
                removeinlocalstorage('bonlivraison', id)

              }
                , function(){ alertify.error('Cancel')});
              // Reset the count
              clicksinbl = 0;
          }
      }

  function addrowbonlivraison(event){
        let target=$(event.target)
        parentdiv=target.parent().parent().parent().parent()
        // this reset the select2 value
        // $('.resultsholderbonlivraison').val('').trigger('change')
        // ids of products in bon stored in localstorage
        let bonachatbody = parentdiv.find('.bonlivraisonbody')
        let addname=parentdiv.find('[name="addname"]')
        let addqty=parentdiv.find('[name="addqty"]')
        let addprice=parentdiv.find('[name="addprice"]')
        let addremise=parentdiv.find('[name="addremise"]')
        let priceclient=parentdiv.find('.addclientprice ').text()
        if (addqty.val()=='' || addprice.val()=='' || addremise.val()==''){
          alertify.error('Veuillez remplir tous les champs')
          return
        }
        var [ref, name, dp, stock, stockfacture, id, sellprice, remise, netprice, representprice] = addname.attr('data').split('§');
        pdcts=JSON.parse(localStorage.getItem('pdctsinbonlivraison{{target}}')) || []
        if (pdcts.includes(id)){
          parentdiv.find('.addstock').val('')
          parentdiv.find('.addstockfacture').val('')
          addqty.val('')
          addname.val('')
          addremise.val('')
          addprice.val('')
          alertify.error('Ce produit est deja dans le bon')
          $('.resultsholderbonlivraison').select2('open')

          return
        }

        // here is the case if qty is greater than stock
        qtyprices=$('.qtyprices')
            prices=0
            qties=0
            achatids=[]
            // what remains from eaach achat
            remainqties=[]
            oldqties=[]
            qty=parseFloat(addqty.val())
            for (let i = 0; i < qtyprices.length; i++) {
              
              let current = $(qtyprices[i]); // get the jQuery object
              oldqtyprice=current.text()
              price=current.parent().find('.price')
              let currentQty = parseFloat(current.text()); // if it's an input use .val(), if span/div use .text()
              if (qty <= 0) {
                console.log('Reached 0 or below, stopping.');
                break; // stop the loop if qty is zero or less
              }
              achatids.push(current.attr('achatid'))
              oldqties.push(currentQty)
              if (qty>=currentQty){
                prices+=currentQty*parseFloat(price.text())
                qties+=currentQty
                current.text(0)
                remainqties.push(0)
              }else{
                newqtyprice=Math.abs(qty-currentQty)
                //diff=oldqtyprice-newqtyprice
                prices+=qty*parseFloat(price.text())
                qties+=qty
                current.text(newqtyprice)
                remainqties.push(newqtyprice)
              }
              qty= qty-currentQty; // decrease qty
                console.log('After item', i, 'qty is now:', qty);
                
            }
            coutmoyen=prices/qties
        if (parseInt(addqty.val())>parseInt(stock)){
          console.log('qty', addqty.val(), 'stock', stock, 'qty > stock', addqty>stock)

          alertify.confirm('Quantité superieur au stock', 'Voulez vous continuer ?', function(){
            if (addqty.val()=='' || addprice.val()=='' || addremise.val()==''){
              alertify.error('Veuillez remplir tous les champs')
              return
            }

            if (pdcts.includes(id)){
              parentdiv.find('.addstock').val('')
              parentdiv.find('.addstockfacture').val('')
              addqty.val('')
              addname.val('')
              addremise.val('')
              addprice.val('')
              alertify.error('Ce produit est deja dans le bon')
              $('.resultsholderbonlivraison').select2('open')
              return
            }
            
            
            pdcts.push(id)
            localStorage.setItem('pdctsinbonlivraison{{target}}', JSON.stringify(pdcts))
            afterremise=parseFloat(addprice.val())*parseFloat(addremise.val())/100
            let net=(parseFloat(addprice.val())-(parseFloat(addprice.val())*parseFloat(addremise.val())/100))
            console.log(net)
            let addtotal=(parseFloat(addqty.val())*parseFloat(net)).toFixed(2)
            let tr = `
            <tr class="itemrow ${stock<=0? "text-danger":"" }" id=${id}>: 2
                <td style="padding: 2px 0; font-size: 13px;" class="ref" onclick="removelinebl(event, ${id})">${ref}</td>
                <td style="padding: 2px 0; font-size: 13px;" class="name text-start">${name}</td>
                <td style="paddingpx 0; font-size: 13px;" class="dp">${dp}</td>
                <td style="padding: 2px 0; font-size: 13px;" class="stock">${stock}</td>
                <td style="padding: 2px 0; font-size: 13px;" class="clientprice">${priceclient}</td>
                <td style="padding: 2px 0; font-size: 13px;"><input type="number" class="calculate qty notemptylivraison" onkeyup="calculate(event); updateinlocalstorage(event, 'bonlivraison', ${id})" name="qty" value="${addqty.val()}" style="height:23px; width:100%;"></td>
                <td style="padding: 2px 0; font-size: 13px;"><input type="number" class="calculate price notemptylivraison" onkeyup="calculate(event); updateinlocalstorage(event, 'bonlivraison', ${id})" name="price" value="${addprice.val()}" step=0.01 style="height:23px; width:100%;"></td>
                <td style="padding: 2px 0; font-size: 13px;"><input type="number" value="${addremise.val()}" class="calculate remise" onkeyup="calculate(event); updateinlocalstorage(event, 'bonlivraison', ${id})" name="remise" style="height:23px; width:100%;"></td>
                <td style="padding: 2px 0; font-size: 13px;" class="netprice">${netprice}</td>
                <td style="padding: 2px 0; font-size: 13px;" class="total">${addtotal}</td>
                <input type="hidden" name="productid" value="${id}">
                <input type="hidden" name="coutmoyen" value="${coutmoyen}" achatids="${achatids}" remainqties="${remainqties}" oldqties="${oldqties}">


            </tr>
            `
            item={
              'id': id,
              'qty': addqty.val(),
              'price': addprice.val(),
              'remise': addremise.val(),
              'total': addtotal,
              'name': name,
              'ref': ref,
              'dp': dp,
              'stock': stock,
              'clientprice': priceclient,
              'netprice': netprice,
              'coutmoyen': coutmoyen,
              'achatids': achatids,
              'remainqties': remainqties,
              'oldqties': oldqties
            }
            // prepare item to be saved in localstorage
            
            bonachatbody.prepend(tr)
            // delete selected option
            parentdiv.find('.addstock').val('')
            parentdiv.find('.addstockfacture').val('')
            addqty.val('')
            addname.val('')
            addremise.val('')
            addprice.val('')
            var totalSum = 0;
            parentdiv.find('.total').each(function() {
              totalSum += parseFloat($(this).text());
            });
            
            console.log('saving items')
            savetolocalstorage(item, totalSum, 'bonlivraison{{target}}')
            parentdiv.find('.totalbon').text(totalSum.toFixed(2))
            parentdiv.find('.resultsholderbonlivraison').select2('open')
          }, function(){
            alertify.error('Cancel')
            parentdiv.find('.resultsholderbonlivraison').select2('open')

          }
          );
          return
        }

        pdcts.push(id)
        localStorage.setItem('pdctsinbonlivraison{{target}}', JSON.stringify(pdcts))
        afterremise=parseFloat(addprice.val())*parseFloat(addremise.val())/100
        let net=(parseFloat(addprice.val())-(parseFloat(addprice.val())*parseFloat(addremise.val())/100))
        let addtotal=(parseFloat(addqty.val())*parseFloat(net)).toFixed(2)
        let tr = `
        <tr class="itemrow ${stock<=0? "text-danger":"" }">: 2
            <td style="padding: 2px 0; font-size: 13px;" class="ref" onclick="removelinebl(event, ${id})">${ref}</td>
            <td style="padding: 2px 0; font-size: 13px;" class="name text-start">${name}</td>
            <td style="paddingpx 0; font-size: 13px;" class="dp">${dp}</td>
            <td style="padding: 2px 0; font-size: 13px;" class="stock">${stock}</td>
            <td style="padding: 2px 0; font-size: 13px;" class="clientprice">${priceclient}</td>
            <td style="padding: 2px 0; font-size: 13px;"><input type="number" class="calculate qty notemptylivraison" onkeyup="calculate(event); updateinlocalstorage(event, 'bonlivraison', ${id})" name="qty" value="${addqty.val()}" style="height:23px; width:100%;"></td>
            <td style="padding: 2px 0; font-size: 13px;"><input type="number" class="calculate price notemptylivraison" onkeyup="calculate(event); updateinlocalstorage(event, 'bonlivraison', ${id})" name="price" value="${addprice.val()}" step=0.01 style="height:23px; width:100%;"></td>
            <td style="padding: 2px 0; font-size: 13px;"><input type="number" value="${addremise.val()}" class="calculate remise" onkeyup="calculate(event); updateinlocalstorage(event, 'bonlivraison', ${id})" name="remise" style="height:23px; width:100%;"></td>
            <td style="padding: 2px 0; font-size: 13px;" class="netprice">${netprice}</td>
            <td style="padding: 2px 0; font-size: 13px;" class="total">${addtotal}</td>
            <input type="hidden" name="productid" value="${id}">
            <input type="hidden" name="coutmoyen" value="${coutmoyen}" achatids="${achatids}" remainqties="${remainqties}" oldqties="${oldqties}">

        </tr>
        `
        item={
          'id': id,
          'qty': addqty.val(),
          'price': addprice.val(),
          'remise': addremise.val(),
          'total': addtotal,
          'name': name,
          'ref': ref,
          'dp': dp,
          'stock': stock,
          'clientprice': priceclient,
          'netprice': netprice,
          'coutmoyen': coutmoyen,
          'achatids': achatids,
          'remainqties': remainqties,
          'oldqties': oldqties
        }
        bonachatbody.prepend(tr)
        // delete selected option
        addqty.val('')
        addname.val('')
        addremise.val('')
        addprice.val('')
        parentdiv.find('.addstock').val('')
          parentdiv.find('.addstockfacture').val('')
        totals=parentdiv.find('.total')
        totalbon=parentdiv.find('.totalbon')
        var totalSum = 0;
        totals.each(function() {
            totalSum += parseFloat($(this).text());
        });
        
        savetolocalstorage(item, totalSum, 'bonlivraison{{target}}')
        totalbon.text(totalSum.toFixed(2))
        // $('.resultsholderbonlivraison').val('').trigger('change')
        $('.resultsholderbonlivraison').select2('open')

        // let selected = $('.resultsholderbonlivraison').find(':selected')
        // selected.remove()

      }


    // finish
    $('.repsselectsbl').on('change', function(){
      if ($(this).val()==''||$('.clientselectbl').val()==''){
        parentdiv.find('.productsholder').addClass('d-none')
        return
      }else{
        parentdiv.find('.productsholder').removeClass('d-none')
        //$.get('products/getclientrep/'+$(this).val(), function(data){
        //  $('.repsselectsbl').val(data.id).trigger('change')
        //})
        $('#productsselect2').select2({


        ajax: {
          type:'get',
          dataType: 'json',
          url: '/products/searchproduct?target={{target}}',
          data: function (params) {
            var query = {
              term: params.term,
            }
            // Query parameters will be ?search=[term]&type=public
            return query;
          },
          // proccessresults: function (data) {
          //     return {
          //       results:data.results
          //     }
          // },
          cache:true
        },
        minimumInputLength: 1,
        placeholder:'Chercher Produits',
        templateResult: formatRepo,
        templateSelection: formatRepoSelection,
      });
        function formatRepo (repo) {
          
          var $container = $(
            `<div class="row"><strong class="col-10" style="color:${repo.stock>0?"blue":"red"};">${repo.text}</strong> <div class="col-2"><img src="${repo.image}" style="width:100%;">${repo.mark}</div></div>`
            );


            return $container;
        }

        function formatRepoSelection (repo) {
          return repo.text;
        }
      }//end else

    })
    $('.clientselectbl').on('change', function(){
      parentdiv=$(this).parent().parent().parent()
      parentdiv.find('.productsholder').removeClass('d-none')
        console.log('check for old unpaid bons')
        $.get('/products/getclientdata', {"id":$('.clientselectbl')
        .val()}, (data)=>{
          $('.sold').text(data.sold)
          
        })
        $('#productsselect2').select2({


        ajax: {
          type:'get',
          dataType: 'json',
          url: '/products/searchproduct?target={{target}}',
          data: function (params) {
            var query = {
              term: params.term,
            }
            // Query parameters will be ?search=[term]&type=public
            return query;
          },
          proccessresults: function (data) {
              return {
                results:data.results
              }
          },
          cache:true
        },
        minimumInputLength: 1,
        placeholder:'Chercher Produits',
        templateResult: formatRepo,
        templateSelection: formatRepoSelection,
      });
      function formatRepo (repo) {
          

        var $container = $(
            `<div class="row"><strong class="col-10" style="color:${repo.stock>0?"blue":"red"};">${repo.text}</strong> <div class="col-2"><img src="${repo.image}" style="width:100%;">${repo.mark}</div></div>`
            );



            return $container;
        }

        function formatRepoSelection (repo) {
          return repo.text;
        }
      // if ($(this).val()==''||$('.repsselectsbl').val()==''){
      //   $.get('products/getclientrep/'+$(this).val(), function(data){
      //     console.log(data)
      //     $('.repblname').text(data.name)
      //     //$('.repsselectsbl').val(data.id).trigger('change')
      //   })
      //   console.log('check for old unpaid bons')
      //   $.get('products/checkoldunpaidbons', {"clientid":$(this).val()}, (data)=>{
      //     if (data.exist){
      //       $('.oldbonswarning').removeClass('d-none')
      //     }else{
      //       $('.oldbonswarning').addClass('d-none')
      //     }
      //   })
      //   parentdiv.find('.productsholder').addClass('d-none')
      //   return
      // }else{
      //   parentdiv.find('.productsholder').removeClass('d-none')
      //   console.log('check for old unpaid bons')
      //   $.get('products/checkoldunpaidbons', {"clientid":$(this).val()}, (data)=>{
      //     if (data.exist){
      //     $('.oldbonswarning').removeClass('d-none')
      //     }else{
      //       $('.oldbonswarning').addClass('d-none')
      //     }
      //   })
      //   $('#productsselect2').select2({


      //   ajax: {
      //     type:'get',
      //     dataType: 'json',
      //     url: '/products/searchproduct?target={{target}}',
      //     data: function (params) {
      //       var query = {
      //         term: params.term,
      //       }
      //       // Query parameters will be ?search=[term]&type=public
      //       return query;
      //     },
      //     proccessresults: function (data) {
      //         return {
      //           results:data.results
      //         }
      //     },
      //     cache:true
      //   },
      //   minimumInputLength: 1,
      //   placeholder:'Chercher Produits',
      //   templateResult: formatRepo,
      //   templateSelection: formatRepoSelection,
      // });
      //   function formatRepo (repo) {
      //     if (repo.loading) {
      //       return repo.text;
      //     }

      //     var $container = $(
      //       `<strong style="color:${repo.stock>0?"blue":"red"};">${repo.text}</div>`
      //       );



      //       return $container;
      //   }

      //   function formatRepoSelection (repo) {
      //     return repo.text;
      //   }
      //}end else

    })
    //localStorage.removeItem('pdctsinbonlivraison{{target}}')
    //localStorage.setItem('pdctsinbonlivraison{{target}}', '[]')

    $(document).ready(function(){
      $('.clientselectbl').select2('open')
      // get products from localstorage
      pdcts=JSON.parse(localStorage.getItem('bonlivraison{{target}}')) || []
      total=localStorage.getItem('totalbonlivraison{{target}}') || 0
      parentdiv=$('.bonlivraisonbody')
      for (let i=0; i<pdcts.length; i++){
        item=pdcts[i]
        let tr = `
        <tr class="itemrow ${item.stock<=0? "text-danger":"" }" id=${item.id}>
            <td style="padding: 2px 0; font-size: 13px;" class="ref" onclick="removelinebl(event, ${item.id})">${item.ref}</td>
            <td style="padding: 2px 0; font-size: 13px;" class="name text-start">${item.name}</td>
            <td style="paddingpx 0; font-size: 13px;" class="dp">${item.dp}</td>
            <td style="padding: 2px 0; font-size: 13px;" class="stock">${item.stock}</td>
            <td style="padding: 2px 0; font-size: 13px;" class="clientprice">${item.clientprice}</td>
            <td style="padding: 2px 0; font-size: 13px;"><input type="number" class="calculate qty notemptylivraison" onkeyup="calculate(event); updateinlocalstorage(event, 'bonlivraison', ${item.id})" name="qty" value="${item.qty}" style="height:23px; width:100%;"></td>
            <td style="padding: 2px 0; font-size: 13px;"><input type="number" class="calculate price notemptylivraison" onkeyup="calculate(event); updateinlocalstorage(event, 'bonlivraison', ${item.id})" name="price" value="${item.price}" step=0.01 style="height:23px; width:100%;"></td>
            <td style="padding: 2px 0; font-size: 13px;"><input type="number" value="${item.remise}" class="calculate remise" onkeyup="calculate(event); updateinlocalstorage(event, 'bonlivraison', ${item.id})" name="remise" style="height:23px; width:100%;"></td>
            <td style="padding: 2px 0; font-size: 13px;" class="netprice">${item.netprice}</td>
            <td style="padding: 2px 0; font-size: 13px;" class="total">${item.total}</td>
            <input type="hidden" name="productid" value="${item.id}">

        </tr>
        `
        parentdiv.prepend(tr)
      }
      $('.totalbon').text(total)
      
      console.log(pdcts)

    })
        // fill today's date in .datebon input
        var dateInput = document.querySelector('.datebonbl');

// Create a new Date object for today
        var today = new Date();

        // Get the current date in the "yyyy-mm-dd" format
        var yyyy = today.getFullYear();
        var mm = String(today.getMonth() + 1).padStart(2, '0'); // Months are zero-indexed, so we add 1
        var dd = String(today.getDate()).padStart(2, '0');

        // Format the date as "yyyy-mm-dd"
        var currentDate = yyyy + '-' + mm + '-' + dd;

        // Set the value of the date input to today's date
        dateInput.value = currentDate;


      $('.resultsholderbonlivraison').on('change', function(){
          console.log($(this).val())
          parentdiv=$(this).parent().parent()
          if ($(this).val()==''){
              return
          }
          var [ref, name, dp, stock, stockfacture, id, sellprice, remise, netprice, representprice] = $(this).val().split('§');
          let repswithprice=[]
          let addname=$(this).parent().parent().find('input[name="addname"]')
          let addprice=$(this).parent().parent().find('input[name="addprice"]')
          let addremise=$(this).parent().parent().find('input[name="addremise"]')
          let addqty=$(this).parent().parent().find('input[name="addqty"]')
          console.log('qty of change',addqty)
          $.get('/products/getqtyprice',
            {
              'target':'{{target}}',
              'id':id
            },
            function(data){
              $('.producthistory').html(data)
            })
          $(this).parent().parent().find('.addstock').text(stock)
          $(this).parent().parent().find('.addstockfacture').text(stockfacture)
          addqty.val('')
          addprice.val(sellprice)
          addremise.val(remise)
          addname.val(`${ref} - ${name}`).attr('data', `${ref}§${name}§${dp}§${stock}§${stockfacture}§${id}§${sellprice}§${remise}§${netprice}§${representprice}`)
          addprice.val(sellprice)
          console.log('getting client price')
          $.ajax({
              url: "{% url 'products:getclientprice' %}",
              type: 'POST',
              data: {
                  'target':'{{target}}',
                  'id': id,
                  'clientid': $('.clientselectbl').val(),
                  'csrfmiddlewaretoken': '{{csrf_token}}'
              },
              success: function(data){
                
                $('.addclientprice').text(`${(data.price).toFixed(2)} (${data.remise})`)
              }
            })

          let selected = $(this).find(':selected')
          // selected.remove()
          // delect selected option
      })

      $('.submitbonlivraison').on('click', (e)=>{
        parentdiv=$(e.target).parent().parent().parent().parent()
        if (parentdiv.find('.clientselectbl').val()==null ||parentdiv.find('.clientselectbl').val()=='' || parentdiv.find('.datebonbl').val()=='' ){
            parentdiv.find('.data').addClass('border border-danger')
            return
        }
        mantant=$('[name="mantantreglementclient"]').val()
        mode=$('[name="modereglementclient"]').val()
        npiece=$('[name="npiece"]').val()
        echeance=$('[name="echeance"]').val()
        parentdiv.find('.data').removeClass('border border-danger')
        // check if .itemrow is exist
        // if (parentdiv.find('.itemrow').length==0){
        //     parentdiv.find('.tableholder').addClass('border border-danger')
        //     return
        // }
        parentdiv.find('.tableholder').removeClass('border border-danger')
          var isAnyEmpty = parentdiv.find('.notemptylivraison').filter(function() { return $(this).val() == ''; }).length > 0;
            if (isAnyEmpty){
                let emptyInputs = parentdiv.find('input.notemptylivraison').filter(function() {
                    return !this.value.trim();
                });

                // Add a red border to all empty input elements
                alertify.error('Veuillez remplir tous les champs obligatoires')
                emptyInputs.css('border', '1px solid red');
                parentdiv.find('input.notemptylivraison').not(emptyInputs).css('border', '');
                $(this).attr('disabled', false)
                return
            }

          parentdiv.find('.submitbonlivraison').addClass('disabled')
          trs=parentdiv.find('.bonlivraisonbody tr')
          let products = []
          trs.each(function(){
              let tr = $(this)
              let qty = tr.find('.qty').val()
              let name = tr.find('.name').text()
              let ref = tr.find('.ref').text()
              let price = tr.find('.price').val()
              let remise = tr.find('.remise').val()
              let total = tr.find('.total').text()
              let clientprice= tr.find('.clientprice').text()
              let achatids= tr.find('input[name="coutmoyen"]').attr('achatids')
              let remainqties= tr.find('input[name="coutmoyen"]').attr('remainqties')
              let oldqties= tr.find('input[name="coutmoyen"]').attr('oldqties')
              let coutmoyen = tr.find('input[name="coutmoyen"]').val()
              let productid = tr.find('input[name="productid"]').val()
              let product = {
                  'qty': qty,
                  'name': name,
                  'ref': ref,
                  'price': price,
                  'remise': remise,
                  'total': total,
                  'productid': productid,
                  'clientprice':clientprice,
                  'coutmoyen': coutmoyen,
                  'achatids':achatids,
                  'remainqties':remainqties,
                  'oldqties':oldqties
              }
              products.push(product)
          })
          let clientid = parentdiv.find('.clientselectbl').val()
          //let repid = parentdiv.find('.repsselectsbl').val()
          let datebon = parentdiv.find('.datebonbl').val()
          let transport = parentdiv.find('.transport').val()
          let note = parentdiv.find('.note').val()
          let totalbon=parseFloat(parentdiv.find('.totalbon').text())
          
          console.log('sending')
          //localStorage.setItem('pdctsinbonlivraison{{target}}', '[]')
          data={
              'totalbon': totalbon,
              'clientid': clientid,
              //'repid':repid,
              'transport':transport,
              'datebon': datebon,
              'note': note,
              'products': JSON.stringify(products),
              'csrfmiddlewaretoken': '{{csrf_token}}'
          },
          
          $.ajax({
              url: "{% url 'products:addbonlivraison' %}",
              type: 'POST',
              data: {
                'target':'{{target}}',
                  'totalbon': totalbon,
                  'clientid': clientid,
                  //'repid':repid,
                  'transport':transport,
                  'datebon': datebon,
                  'mantant': mantant,
                  'mode': mode,
                  'npiece': npiece,
                  'echeance': echeance,
                  'devid': "",
                  'cmndid': "",
                  'note': note,
                  'products': JSON.stringify(products),
                  'csrfmiddlewaretoken': '{{csrf_token}}'
              },
              success: function(data){
                console.log('sent')
                  // remove list in localstorage
                  removelocalstorage('bonlivraison{{target}}')
                  //deletetab('addbonlivraison')
                  ajaxpage('addlistbonlivraison', 'list bl', '/products/listbonlivraison?target={{target}}')


              }
          })

        })
      $('.searchbonlivraisoncreation').on("keyup", function() {
    var value = $(this).val().toLowerCase();
    $(".bonlivraisoncreation tbody tr").filter(function() {
      $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)
    });
  });



      // const selectElement = document.getElementById("my-select");

      // selectElement.addEventListener("keydown", function(event) {
      //     if (event.key === "Enter") {

      //         var [ref, name, dp, stock, id] = selectElement.value.split('§');
      //         let bonachatbody = $('.bonachatbody')
      //         let tr = `
      //         <tr>
      //             <td class="ref">${ref}</td>
      //             <td class="name">${name}</td>
      //             <td>${dp}</td>
      //             <td>${stock}</td>
      //             <td>
      //                 <select name"local" class="form-select local">
      //                     <option value="principal">Principal</option>
      //                     <option value="depot">Depot</option>
      //                 </select>
      //             </td>
      //             <td><input type="number" class="form-control calculate qty" onkeyup="calculate(event); updateinlocalstorage(event, 'bonlivraison', ${id})" name="qty"></td>
      //             <td><input type="number" class="form-control calculate price" onkeyup="calculate(event); updateinlocalstorage(event, 'bonlivraison', ${id})" name="price"></td>
      //             <td><input type="number" class="form-control calculate remise" onkeyup="calculate(event); updateinlocalstorage(event, 'bonlivraison', ${id})" name="remise"></td>
      //             <td class="total"></td>
      //             <input type="hidden" name="productid" value="${id}">
      //             <td><button class="btn btn-danger btn-sm" onclick="removefrombon(this)">X</button></td>
      //         </tr>
      //         `
      //         bonachatbody.prepend(tr)
      //         // delect selected option
      //         selectElement.remove(selectElement.selectedIndex);
      //     }
      // });


      // const addtobon=(e, ref, name, stock)=>{
      //     let target = $(e.target)
      //     console.log(target)
      //     target.remove()
      //     let bonachatbody = $('.bonachatbody')
      //     let tr = `
      //     <tr>
      //         <td>${ref}</td>
      //         <td>${name}</td>
      //         <td>${stock}</td>

      //         <td><input type="number" class="form-control calculate qty" onkeyup="calculate(event); updateinlocalstorage(event, 'bonlivraison', ${id})" name="qty"></td>
      //         <td><input type="number" class="form-control calculate price" onkeyup="calculate(event); updateinlocalstorage(event, 'bonlivraison', ${id})" name="price"></td>
      //         <td class="total"></td>
      //         <td><button class="btn btn-danger btn-sm" onclick="removefrombon(this)">X</button></td>
      //     </tr>
      //     `
      //     bonachatbody.append(tr)
      // }


  </script>
